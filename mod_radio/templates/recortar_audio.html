{% extends "radio_base.html" %}

{% block content %}

<div class="container py-4">
  <h3 class="mb-4 text-center">âœ‚ï¸ Recortar Ãudio â€” {{ nome_arquivo }}</h3>

  <!-- Player visual -->
  <div id="waveform" class="mb-3 border rounded shadow-sm" style="height: 150px; background: #f8f9fa;"></div>

  <!-- Controles de reproduÃ§Ã£o -->
  <div class="d-flex justify-content-center align-items-center gap-3 mb-4 flex-wrap">
    <button id="playPause" class="btn btn-primary px-4 py-2 fs-5">
      â–¶ï¸ Reproduzir
    </button>

    <!-- Controle de Zoom -->
    <div class="d-flex align-items-center gap-2">
      <label for="zoomSlider" class="form-label mb-0 fw-semibold">ğŸ” Zoom</label>
      <input type="range" id="zoomSlider" min="0" max="200" value="0" step="5" style="width: 120px;">
    </div>

    <!-- Controle de Volume -->
    <div class="d-flex align-items-center gap-2">
      <span id="volumeIcon">ğŸ”Š</span>
      <input type="range" id="volumeSlider" min="0" max="1" value="1" step="0.05" style="width: 120px;">
    </div>
  </div>

  <!-- FormulÃ¡rio de recorte -->
  <form id="formRecorte" method="post" action="{{ url_for('radio.recortar_download') }}">
    <input type="hidden" name="path" value="{{ path }}">

    <div class="row mb-3">
      <div class="col-md-4">
        <label for="inicio" class="form-label">InÃ­cio (segundos)</label>
        <input type="number" step="0.1" name="inicio" id="inicio" class="form-control" value="0">
      </div>
      <div class="col-md-4">
        <label for="fim" class="form-label">Fim (segundos)</label>
        <input type="number" step="0.1" name="fim" id="fim" class="form-control" value="10">
      </div>
      <div class="col-md-4 d-flex align-items-end justify-content-around">
        <button type="button" id="markStart" class="btn btn-outline-success">ğŸ“ Marcar InÃ­cio</button>
        <button type="button" id="markEnd" class="btn btn-outline-danger">ğŸ“ Marcar Fim</button>
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100">ğŸ’¾ Gerar e Baixar Recorte</button>
  </form>
</div>

<!-- Wavesurfer.js -->
<script src="https://unpkg.com/wavesurfer.js"></script>
<script src="https://unpkg.com/wavesurfer.js/dist/plugins/regions.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("ğŸ§ [DEBUG] Script iniciado");

  const rawPath = "{{ path | replace('\\', '/') }}";
  const audioURL = "{{ url_for('radio.play_audio') }}?path=" + encodeURIComponent(rawPath);
  console.log("ğŸ§ [DEBUG] URL do Ã¡udio:", audioURL);

  const btnPlay = document.getElementById('playPause');
  const zoomSlider = document.getElementById('zoomSlider');
  const volumeSlider = document.getElementById('volumeSlider');
  const volumeIcon = document.getElementById('volumeIcon');
  const btnMarkStart = document.getElementById('markStart');
  const btnMarkEnd = document.getElementById('markEnd');
  const inputInicio = document.getElementById('inicio');
  const inputFim = document.getElementById('fim');
  const formRecorte = document.getElementById('formRecorte');
  const container = document.querySelector(".container");

  // Ãrea de status
  const tempoInfo = document.createElement('div');
  tempoInfo.className = "text-center my-3 text-muted fw-semibold";
  tempoInfo.id = "tempoInfo";
  tempoInfo.innerHTML = "â³ Carregando Ã¡udio...";
  container.appendChild(tempoInfo);

  // Criar player Wavesurfer
  const wavesurfer = WaveSurfer.create({
    container: '#waveform',
    waveColor: '#d3d3d3',
    progressColor: '#007bff',
    cursorColor: '#ff0000',
    height: 120,
    barWidth: 2,
    responsive: true,
  });

  const regions = wavesurfer.registerPlugin(WaveSurfer.Regions.create());
  let reg = null;

  // ğŸ”¹ Carrega o Ã¡udio automaticamente
  (async () => {
    try {
      await wavesurfer.load(audioURL);
      console.log("âœ… [DEBUG] Ãudio prÃ©-carregado");
    } catch (err) {
      console.error("âŒ Falha ao carregar:", err);
      tempoInfo.innerHTML = "âš ï¸ Erro ao carregar o Ã¡udio.";
    }
  })();

  // ğŸ® Controle Play/Pause
  btnPlay.addEventListener('click', async () => {
    const ac = wavesurfer.getAudioContext?.();
    if (ac && ac.state === 'suspended') await ac.resume();
    wavesurfer.playPause();
  });

  // ğŸ“ Controle de Zoom
  zoomSlider.addEventListener('input', (e) => {
    const zoomLevel = parseInt(e.target.value);
    wavesurfer.zoom(zoomLevel);
  });

  // ğŸ”Š Controle de Volume
  volumeSlider.addEventListener('input', (e) => {
    const vol = parseFloat(e.target.value);
    wavesurfer.setVolume(vol);

    if (vol === 0) volumeIcon.textContent = "ğŸ”‡";
    else if (vol < 0.5) volumeIcon.textContent = "ğŸ”‰";
    else volumeIcon.textContent = "ğŸ”Š";
  });

  // ğŸµ Quando o Ã¡udio estiver pronto
  wavesurfer.on('ready', () => {
    const total = wavesurfer.getDuration();
    inputFim.value = Math.floor(total);
    tempoInfo.innerHTML = `
      â±ï¸ Tempo: <span id='tempoAtual'>0.0</span>s / <span id='tempoTotal'>${total.toFixed(1)}</span>s
      &nbsp; | &nbsp; ğŸ¯ DuraÃ§Ã£o do recorte: <span id='duracao'>0.0</span>s
      <br>ğŸµ Status: <span id='status'>â¸ï¸ Parado</span>
    `;

    reg = regions.addRegion({
      start: 0,
      end: Math.min(10, total),
      color: 'rgba(0, 123, 255, 0.3)',
      drag: true,
      resize: true,
    });

    atualizarDuracao();
  });

  // Atualiza tempo corrente
  wavesurfer.on('timeupdate', (current) => {
    const tempoEl = document.getElementById('tempoAtual');
    if (tempoEl) tempoEl.textContent = current.toFixed(1);
  });

  // Controle visual do botÃ£o e status
  wavesurfer.on('play', () => {
    btnPlay.innerHTML = "â¸ï¸ Pausar";
    btnPlay.classList.replace("btn-primary", "btn-warning");
    const s = document.getElementById('status');
    if (s) s.textContent = "ğŸ”Š Tocando...";
    if (reg) reg.setOptions({ color: 'rgba(40,167,69,0.3)' });
  });

  wavesurfer.on('pause', () => {
    btnPlay.innerHTML = "â–¶ï¸ Reproduzir";
    btnPlay.classList.replace("btn-warning", "btn-primary");
    const s = document.getElementById('status');
    if (s) s.textContent = "â¸ï¸ Pausado";
    if (reg) reg.setOptions({ color: 'rgba(0,123,255,0.3)' });
  });

  wavesurfer.on('finish', () => {
    btnPlay.innerHTML = "â–¶ï¸ Reproduzir";
    btnPlay.classList.replace("btn-warning", "btn-primary");
    const s = document.getElementById('status');
    if (s) s.textContent = "ğŸ” Finalizado";
  });

  // Atualiza campos ao mover regiÃ£o
  regions.on('region-updated', (region) => {
    inputInicio.value = region.start.toFixed(1);
    inputFim.value = region.end.toFixed(1);
    atualizarDuracao();
  });

  // Sincroniza manualmente inÃ­cio/fim
  inputInicio.addEventListener('input', atualizarRegiao);
  inputFim.addEventListener('input', atualizarRegiao);

  function atualizarRegiao() {
    if (!reg) return;
    const ini = parseFloat(inputInicio.value) || 0;
    const fim = parseFloat(inputFim.value) || 0;
    reg.setOptions({ start: Math.min(ini, fim), end: Math.max(ini, fim) });
    atualizarDuracao();
  }

  // BotÃµes Marcar InÃ­cio/Fim
  btnMarkStart.addEventListener('click', () => {
    const current = wavesurfer.getCurrentTime();
    inputInicio.value = current.toFixed(1);
    atualizarRegiao();
  });

  btnMarkEnd.addEventListener('click', () => {
    const current = wavesurfer.getCurrentTime();
    inputFim.value = current.toFixed(1);
    atualizarRegiao();
  });

  // Atualiza duraÃ§Ã£o
  function atualizarDuracao() {
    const ini = parseFloat(inputInicio.value) || 0;
    const fim = parseFloat(inputFim.value) || 0;
    const dur = Math.max(0, fim - ini);
    const duracaoEl = document.getElementById('duracao');
    if (duracaoEl) duracaoEl.textContent = dur.toFixed(1);
  }

  // Atalhos de teclado
  document.addEventListener('keydown', (e) => {
    const tag = e.target.tagName.toLowerCase();
    if (tag === 'input' || tag === 'textarea') return;

    switch (e.code) {
      case 'Space':
        e.preventDefault();
        btnPlay.click();
        break;
      case 'KeyI':
        btnMarkStart.click();
        break;
      case 'KeyO':
        btnMarkEnd.click();
        break;
      case 'Enter':
        e.preventDefault();
        formRecorte.submit();
        break;
    }
  });
});
</script>

{% endblock %}
