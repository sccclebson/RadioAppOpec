{% extends "radio_base.html" %}
{% block title %}Recortar √Åudio{% endblock %}

{% block content %}
<div class="container py-4">
  <h4 class="mb-4"><i class="bi bi-scissors"></i> Recortar √Åudio</h4>

  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">R√°dio {{ radio.nome }}</h5>
      <p><strong>Arquivo:</strong> {{ nome_arquivo }}</p>
      <p><strong>Caminho completo:</strong> {{ path }}</p>
    </div>
  </div>

  <!-- Player de √°udio -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div id="waveform"></div>
      <div class="mt-3 text-center">
        <button id="btnPlay" class="btn btn-primary me-2">
          <i class="bi bi-play-circle"></i> Reproduzir / Pausar
        </button>
        <button id="btnStop" class="btn btn-secondary me-2">
          <i class="bi bi-stop-circle"></i> Parar
        </button>
        <button id="btnZoomIn" class="btn btn-outline-primary me-2">üîç Zoom +</button>
        <button id="btnZoomOut" class="btn btn-outline-primary">üîç Zoom -</button>
      </div>
    </div>
  </div>

  <!-- Formul√°rio de recorte -->
  <form id="formRecorte" method="POST"
        action="{{ url_for('radio.recortar_audio', radio_key=radio.key) }}"
        class="card shadow-sm p-3">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="inicio" class="form-label">In√≠cio (mm:ss)</label>
        <input type="text" id="inicio" name="inicio" class="form-control" value="00:00" required>
      </div>
      <div class="col-md-4">
        <label for="fim" class="form-label">Fim (mm:ss)</label>
        <input type="text" id="fim" name="fim" class="form-control" value="00:30" required>
      </div>
      <div class="col-md-4 text-end">
        <button type="submit" class="btn btn-success">
          <i class="bi bi-scissors"></i> Recortar e Baixar
        </button>
      </div>
    </div>

    <input type="hidden" name="path" value="{{ path }}">
    <input type="hidden" name="nome_arquivo" value="{{ nome_arquivo }}">
  </form>
</div>

<!-- WaveSurfer.js -->
<script src="https://unpkg.com/wavesurfer.js@7.0.3/dist/wavesurfer.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7.0.3/dist/plugins/regions.min.js"></script>

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", async () => {
  // Caminho absoluto do arquivo recebido do Flask
  const rawPath = "{{ path | replace('\\', '/') }}";
  const playURL = "/radio/play?path=" + encodeURIComponent(rawPath);

  console.log("üéß Caminho original:", rawPath);
  console.log("üéß URL final de reprodu√ß√£o:", playURL);

  // Cria√ß√£o do WaveSurfer
  const wavesurfer = WaveSurfer.create({
    container: "#waveform",
    waveColor: "#cce5ff",
    progressColor: "#007bff",
    height: 100,
  });

  // Controles de reprodu√ß√£o
  const btnPlay = document.getElementById("btnPlay");
  const btnStop = document.getElementById("btnStop");
  const btnZoomIn = document.getElementById("btnZoomIn");
  const btnZoomOut = document.getElementById("btnZoomOut");

  btnPlay.addEventListener("click", () => wavesurfer.playPause());
  btnStop.addEventListener("click", () => wavesurfer.stop());
  btnZoomIn.addEventListener("click", () => wavesurfer.zoom(wavesurfer.params.minPxPerSec * 1.2));
  btnZoomOut.addEventListener("click", () => wavesurfer.zoom(wavesurfer.params.minPxPerSec / 1.2));

  try {
    await wavesurfer.load(playURL);
    console.log("‚úÖ √Åudio carregado com sucesso!");
  } catch (err) {
    console.error("‚ùå Erro ao carregar o √°udio:", err);
  }
});
</script>
{% endblock %}
{% endblock %}
