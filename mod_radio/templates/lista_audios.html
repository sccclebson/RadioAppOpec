{% extends "radio_base.html" %}
{% block title %}Listagem de √Åudios{% endblock %}
{% block content %}
<div class="container py-4">
  <h4 class="mb-4 text-center">
    üéß √Åudios ‚Äî <span class="text-primary">Radio {{ radio.nome }}</span>
  </h4>

  <!-- üîé Filtros -->
  <form id="formFiltro" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" id="filtroData" name="data" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Hora In√≠cio</label>
      <input type="time" id="filtroHoraIni" name="hora_ini" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Hora Fim</label>
      <input type="time" id="filtroHoraFim" name="hora_fim" class="form-control">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
    </div>
  </form>

  <!-- üìã Tabela -->
  <div class="table-responsive">
    <table class="table table-striped align-middle" id="tabelaAudios">
      <thead class="table-dark">
        <tr>
          <th>Arquivo</th>
          <th>Data de Cria√ß√£o</th>
          <th>Tamanho</th>
          <th>Ouvir</th>
          <th>Recortar</th>
        </tr>
      </thead>
      <tbody id="tbodyAudios">
        <tr><td colspan="5" class="text-center">Carregando...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="paginacao" class="mt-3 text-center"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const radioKey = "{{ radio.key }}";
  const tbody = document.getElementById("tbodyAudios");
  const form = document.getElementById("formFiltro");
  const pagDiv = document.getElementById("paginacao");

  const campoData = document.getElementById("filtroData");
  const campoHoraIni = document.getElementById("filtroHoraIni");
  const campoHoraFim = document.getElementById("filtroHoraFim");

  const hoje = new Date();
  const hojeStr = hoje.toISOString().split("T")[0];
  campoData.value = hojeStr;
  campoHoraIni.value = "00:00";
  campoHoraFim.value = "23:59";

  // üîÑ Fun√ß√£o para carregar os √°udios via AJAX
  async function carregarAudios(page = 1) {
    const data = campoData.value;
    const horaIni = campoHoraIni.value;
    const horaFim = campoHoraFim.value;

    tbody.innerHTML = `<tr><td colspan="5" class="text-center">‚è≥ Carregando...</td></tr>`;
    try {
      const url = `/radio/audios/data?radio=${radioKey}&data=${data}&hora_ini=${horaIni}&hora_fim=${horaFim}&page=${page}`;
      const resp = await fetch(url);
      const dataJson = await resp.json();

      if (!dataJson.itens || !dataJson.itens.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Nenhum √°udio encontrado.</td></tr>`;
        pagDiv.innerHTML = "";
        return;
      }

      tbody.innerHTML = "";
      dataJson.itens.forEach(a => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${a.nome}</td>
          <td>${a.datahora}</td>
          <td>${a.tamanho} KB</td>
          <td>
            <audio controls preload="none">
              <source src="{{ url_for('radio.servir_audio', subpath='__REPLACE__') }}"
                      type="audio/mpeg">
            </audio>
          </td>
          <td>
            <a href="{{ url_for('radio.recortar_audio', radio_key=radio.key) }}?subpath=__REPLACE__"
               class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-scissors"></i> Recortar
            </a>
          </td>
        `;
        // substitui marcador __REPLACE__ pelo subpath real do JSON
        row.innerHTML = row.innerHTML.replaceAll("__REPLACE__", a.subpath);
        tbody.appendChild(row);
      });

      // Pagina√ß√£o (mant√©m a tua l√≥gica atual)
      const total = dataJson.total;
      const perPage = dataJson.per_page;
      const totalPag = Math.ceil(total / perPage);
      const atual = dataJson.page;
      pagDiv.innerHTML = "";
      if (totalPag > 1) {
        for (let i = 1; i <= totalPag; i++) {
          const btn = document.createElement("button");
          btn.className = `btn btn-sm ${i === atual ? 'btn-primary' : 'btn-outline-primary'} mx-1`;
          btn.textContent = i;
          btn.onclick = () => carregarAudios(i);
          pagDiv.appendChild(btn);
        }
      }
    } catch (err) {
      console.error("Erro ao carregar √°udios:", err);
      tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Erro ao carregar √°udios.</td></tr>`;
    }
  }

  // üìÖ Submiss√£o do filtro
  form.addEventListener("submit", ev => {
    ev.preventDefault();
    carregarAudios();
  });

  // üöÄ Carrega automaticamente os √°udios do dia
  carregarAudios();
});
</script>

{% endblock %}
