{% extends "radio_base.html" %}
{% block title %}Listagem de √Åudios{% endblock %}
{% block content %}
<div class="container py-4">
  <h4 class="mb-4 text-center">
    üéß √Åudios ‚Äî <span class="text-primary">Radio {{ radio.nome }}</span>
  </h4>

  <!-- Filtros -->
  <form id="formFiltro" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Data</label>
      <input type="date" id="filtroData" name="data" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Hora In√≠cio</label>
      <input type="time" id="filtroHoraIni" name="hora_ini" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Hora Fim</label>
      <input type="time" id="filtroHoraFim" name="hora_fim" class="form-control">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-funnel"></i> Filtrar
      </button>
    </div>
  </form>

  <!-- Tabela -->
  <div class="table-responsive">
    <table class="table table-striped align-middle" id="tabelaAudios">
      <thead class="table-dark">
        <tr>
          <th>Arquivo</th>
          <th>Data de Cria√ß√£o</th>
          <th>Tamanho</th>
          <th>Ouvir</th>
          <th>Recortar</th>
        </tr>
      </thead>
      <tbody id="tbodyAudios">
        <tr><td colspan="5" class="text-center">Carregando...</td></tr>
      </tbody>
    </table>
  </div>

  <div id="paginacao" class="mt-3 text-center"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const radioKey = "{{ radio.key }}";
  const tbody = document.getElementById("tbodyAudios");
  const form = document.getElementById("formFiltro");
  const pagDiv = document.getElementById("paginacao");

  async function carregarAudios(page = 1) {
    const data = document.getElementById("filtroData").value;
    const horaIni = document.getElementById("filtroHoraIni").value;
    const horaFim = document.getElementById("filtroHoraFim").value;

    // üóìÔ∏è Define a data de hoje automaticamente
    const campoData = document.getElementById("filtroData");
    const hoje = new Date();
    const hojeStr = hoje.toISOString().split("T")[0]; // Formato YYYY-MM-DD
    campoData.value = hojeStr;

    // üîÑ Carrega automaticamente os √°udios do dia atual

    tbody.innerHTML = `<tr><td colspan="5" class="text-center">‚è≥ Carregando...</td></tr>`;

    try {
      const url = `/radio/audios/data?radio=${radioKey}&data=${data}&hora_ini=${horaIni}&hora_fim=${horaFim}&page=${page}`;
      const resp = await fetch(url);
      const dataJson = await resp.json();

      if (!dataJson.ok || !dataJson.audios.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Nenhum √°udio encontrado.</td></tr>`;
        pagDiv.innerHTML = "";
        return;
      }

      tbody.innerHTML = "";
      dataJson.audios.forEach(a => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${a.nome}</td>
          <td>${a.datahora}</td>
          <td>${a.tamanho} KB</td>
          <td>
            <audio controls preload="none" style="width:180px">
              <source src="/media/${encodeURIComponent(a.path.replace(/^.*media_drive[\\/]/, ''))}" type="audio/mpeg">
              Seu navegador n√£o suporta √°udio.
            </audio>
          </td>
          <td>
            <a href="/radio/${radioKey}/recortar?path=${encodeURIComponent(a.path)}"
               class="btn btn-outline-danger btn-sm">
              <i class="bi bi-scissors"></i> Recortar
            </a>
          </td>
        `;
        tbody.appendChild(row);
      });

      // Pagina√ß√£o
      const total = dataJson.total;
      const atual = dataJson.pagina_atual;
      const totalPag = dataJson.total_paginas;
      pagDiv.innerHTML = "";
      if (totalPag > 1) {
        for (let i = 1; i <= totalPag; i++) {
          const btn = document.createElement("button");
          btn.className = `btn btn-sm ${i === atual ? 'btn-primary' : 'btn-outline-primary'} mx-1`;
          btn.textContent = i;
          btn.onclick = () => carregarAudios(i);
          pagDiv.appendChild(btn);
        }
      }

      console.log(`üéß ${dataJson.audios.length} √°udios carregados (p√°gina ${atual}/${totalPag})`);
    } catch (err) {
      console.error("Erro ao carregar √°udios:", err);
      tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Erro ao carregar √°udios.</td></tr>`;
    }
  }

  // Recarrega com o filtro
  form.addEventListener("submit", ev => {
    ev.preventDefault();
    carregarAudios();
  });

  carregarAudios();
});
</script>
{% endblock %}
